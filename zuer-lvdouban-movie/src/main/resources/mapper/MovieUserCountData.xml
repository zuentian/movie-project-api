<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zuer.zuerlvdoubanmovie.dao.MovieUserCountDataDao">

    <insert id="insertCountByMovieId" parameterType="java.lang.String">
        INSERT INTO MOVIE_USER_COUNT_DATA
            (MOVIE_ID,BEFORE_WATCH_CT,AFTER_WATCH_CT,UPD_DATE)
        VALUES
            (#{movieId},
            SELECT COUNT(MOVIE_ID) FROM MOVIE_USER_RECORD WHERE MOVIE_ID = #{movieId} AND STATE='1',
            SELECT COUNT(MOVIE_ID) FROM MOVIE_USER_RECORD WHERE MOVIE_ID = #{movieId} AND STATE='2',
            NOW()
            )
    </insert>

    <update id="updateCountByMovieId" parameterType="java.lang.String">
        UPDATE MOVIE_USER_COUNT_DATA
        SET
            BEFORE_WATCH_CT = (
            SELECT COUNT(MOVIE_ID) FROM MOVIE_USER_RECORD
            WHERE
                MOVIE_ID = #{movieId}
                AND state = '1'
            ),
            AFTER_WATCH_CT = (
                SELECT COUNT(MOVIE_ID) FROM MOVIE_USER_RECORD
                WHERE
                    MOVIE_ID = #{movieId}
                  AND state = '2'
            )
        WHERE
            MOVIE_ID = #{movieId}
    </update>
</mapper>